# Deploying the production environment

The way that the Frontend Docs website is deployed is very similar to [the way
that the Design System is deployed][ds-deploy].

## Overview

Frontend Docs is a static site which is generated by
[Middleman](https://middlemanapp.com/).

When the main branch changes, [Github Actions][github-actions] will build the
static site by running `bundle exec middleman build`. As long as that succeeds,
the contents of the deploy directory will then by uploaded to our application on
[GOV.UK Platform as a Service][paas] (PaaS).

We use nginx as a simple web server.

## Github Actions

There are two workflows used to test and deploy the Frontend Docs website.

### Testing

The test workflow is configured in [.github/workflows/test.yaml](/.github/workflows/test.yaml).

This workflow is set to run on every branch except `main`, where it is instead 
run as a dependency on the deployment workflow.

The workflow will ensure the Frontend Docs website can be built successfully,
then run the linter and the tests.

### Deployment

The deployment workflow is configured in [.github/workflows/deploy.yaml](/.github/workflows/deploy.yaml).

This workflow only runs on the `main` branch, as a deployment to the [production
environment][gh-env]. It uses a [concurrency group][gh-concurrency] to prevent
multiple workflows from trying to deploy at the same time.

Before deploying, the workflow will:

- run the test workflow, passing the built site from that workflow as an
  artefact to be deployed
- check that the version of the site being deployed matches the current main
  branch, to prevent an old job being re-run and an old version of the site
  being deployed

We define healthchecks in the manifest file to check that the `/canary.html`
path returns a 200 response, which indicates that the deployed instance is
running correctly.

## Hosting on GOV.UK Platform as a Service (PaaS)

We deploy to the `govuk-frontend-docs` app.

This app exists within the `govuk-design-system` organisation and the
`frontend-docs` space, and is deployed by the
`design-system-deploy+frontend-docs@digital.cabinet-office.gov.uk` user â€“ the
credentials for which can be found in BitWarden.

We use an [application manifest](/deploy/manifest.yml) to configure the app name
and the type of buildpack that we want to use.

See [PaaS documentation](https://docs.cloud.service.gov.uk/) for how to sign in
and deploy apps.

### nginx

We use the [nginx buildpack][nginx-bp]. Nginx is configured in
[nginx.conf](../../deploy/nginx.conf).

## Content Delivery Network (CDN)

We use a CDN to cache assets and to terminate the SSL for the service domain.
We don't cache HTML files.

This uses the [`cdn-route` service][cdn-route] provided by PaaS, which in turn
provides a CloudFront distribution which we CNAME the service domain to.

Caching respects the expires headers that we send from nginx.

If you suspect issues with caching on the service domain, you can bypass the CDN
by visiting https://govuk-frontend-docs.cloudapps.digital.

Authentication is enabled on this domain to prevent indexing and minimise
confusion. The username is `origin` and the password is `badidea`.

## DNS

`frontend.design-system.service.gov.uk` is a subdomain of the `service.gov.uk`
zone and is defined in [`alphagov/govuk-dns-config`][govuk-dns-config] (private
repo) and deployed by the GOV.UK 2nd Line team using [`alphagov/govuk-dns`
][govuk-dns]. Support queries relating to DNS are best sent to 
`hostmaster@digit...`.

For rationale behind this approach, see the [Design System deployment docs][ds-deploy].

[github-actions]: https://github.com/alphagov/govuk-frontend-docs/actions
[paas]: https://www.cloud.service.gov.uk/
[nginx-bp]: https://github.com/cloudfoundry/nginx-buildpack
[govuk-dns-config]: https://github.com/alphagov/govuk-dns-config/blob/master/service.gov.uk.yaml
[govuk-dns]: https://github.com/alphagov/govuk-dns
[cdn-route]: https://docs.cloud.service.gov.uk/#set-up-a-custom-domain-using-the-cdn-route-service
[gh-env]: https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment
[gh-concurrency]: https://docs.github.com/en/actions/using-jobs/using-concurrency
[ds-deploy]: https://github.com/alphagov/govuk-design-system/blob/main/docs/deployment/production.md
