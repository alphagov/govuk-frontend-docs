language: ruby
# Use Ruby 2.6 to avoid requiring the installed bundler version to exactly
# match the version in Gemfile.lock, as seen in the version of RubyGems that
# shipped with Ruby 2.5.
dist: bionic
cache: bundler
script:
  - bundle exec middleman build
  - bundle exec rake
  - npm run check-links

env:
  global:
  # CloudFoundry credentials for deployment
  - CF_API="https://api.cloud.service.gov.uk"
  - CF_ORG="govuk-design-system"
  - CF_SPACE="frontend-docs"
  - CF_USERNAME="design-system-deploy+frontend-docs@digital.cabinet-office.gov.uk"
  # CF_PASSWORD
  - secure: "PKA7lTGjyRMWbMvP9Go6fuzuMcAIM6O91X+N5sgKfK8Es22mIUJgnbSGbaP4Y2PGVDahnBJ/qI6+0Qm+1lvLa6gZeB2knPMT7E4lIM4w7/MEZQWV9YYupjB1ZB1ROfXGgkbaWB+f5bXuRuxJowMwTPPjD9G6enWpzhj8LmH2Xhfz4YEqxO81lrPGz67t8WJr9GmAZoNIkyLJj0QF1IiJwNVec2gEpabWZol62K6gv7yFIqA7IJXw5QWVTOuACu4Tz/U3R3B0m+pxNp+PFpZaJvv3Zirdr2NospZoH4u7tbHvtFqEHLUwYaXLAVQVwtfForePNjvdzXcgn05//OjuyReHQC06BMmzVvyvi8ZZNeUj1pPyHehEAoWmGcZiztecYVnPhC+9Swp/Wc1bp4G9uYPYny4zQnWTdeNMG0Q14v9mbjBICtUJ+wjahQu5zjwbkFZVhMqLeCc8SsQxumQOZylZ8t/xqrupkD5ce256kUGO56BeKzFkeD+0szg7eLMD6YvjY1w4y3//vUKDGgTVzV30pR8YOcWOk+dYf64ixRWGCs9/5cxZYEuSqqiFCgLKkBSdh9IhaDtC7WpDuf0ruhLHT32UI92Uf8m7OAbFVZUSNUKQhtxmyP56fIXJSNCOVUESVnQ+7aHnVZCD76sc5+SpnSszqO33UQMWFj1hDMc="

# Install CloudFoundry CLI tools
before_deploy:
  - wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
  - echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
  - sudo apt-get update
  - sudo apt-get install -y cf7-cli

before_script:
  - npm install

# We use a script rather than using Travis' built in CloudFoundry provider
# because it does not support zero downtime deploys
# (https://github.com/travis-ci/dpl/pull/610)
deploy:
  provider: script
  script: "./bin/deploy-travis"
  # We build the site as part of the build, so we want to keep it so it can be
  # deployed!
  skip_cleanup: true
  on:
    branch: main
